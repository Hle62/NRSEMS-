<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº çŠ¯ç½ªé›»å“</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        h1 { border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        .crime-item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .crime-item label { margin-right: 15px; }
        #crime-list { min-height: 50px; }
        .loading { color: gray; font-style: italic; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; margin-top: 10px; }
        #result-display { margin-top: 20px; padding: 15px; border: 2px solid #333; font-size: 24px; font-weight: bold; background-color: #f9f9f9; text-align: center; }
        .alert { color: red; }
    </style>
</head>
<body>
    <h1>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº çŠ¯ç½ªé›»å“</h1>

    <h2>çŠ¯ç½ªã”ã¨ã®ä»‹å…¥äººæ•°ã¨é‡‘é¡ã®é¸æŠ</h2>
    
    <div id="crime-list" class="loading">
        ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰çŠ¯ç½ªãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...
    </div>
    
    <button id="calculate-button">åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—</button>

    <div id="result-display">
        åˆè¨ˆé‡‘é¡: <span id="result-amount">0</span> å††
    </div>

    <script>
        // ğŸš¨ ã€è¨­å®šæ¸ˆã¿ã€‘ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸGASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyB7GM9D-Rr9_Sx9zYcnhEfdrZe3VaI1YndoFQuCz-xcwbe6r5rKvOeKs6lnp_4xwaUSg/exec';
        const crimeListElement = document.getElementById('crime-list');
        const resultAmountSpan = document.getElementById('result-amount');

        /**
         * GASã‹ã‚‰çŠ¯ç½ªåãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€UIã‚’å‹•çš„ã«æ§‹ç¯‰ã™ã‚‹
         */
        async function fetchCrimesAndBuildUI() {
            try {
                // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§çŠ¯ç½ªåã®ãƒªã‚¹ãƒˆã‚’å–å¾—
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error(`HTTP status ${response.status}`);
                }
                
                const text = await response.text();
                const data = JSON.parse(text);
                
                if (data.error || !data.crimeList) {
                     throw new Error(`GAS Script Error: ${data.error || 'ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'}`);
                }

                crimeListElement.classList.remove('loading');
                crimeListElement.innerHTML = '';
                
                // çŠ¯ç½ªåã”ã¨ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
                data.crimeList.forEach((crimeName, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'crime-item';
                    itemDiv.innerHTML = `
                        <input type="checkbox" id="crime-${index}" name="crime" value="${crimeName}">
                        <label for="crime-${index}"><strong>${crimeName}</strong></label>
                        <br>
                        <fieldset style="display: inline-block; margin-top: 5px;">
                            <legend>ä»‹å…¥äººæ•°</legend>
                            <label>
                                <input type="radio" name="intervention-${index}" value="2_or_less" checked> 2äººä»¥ä¸‹
                            </label>
                            <label>
                                <input type="radio" name="intervention-${index}" value="3_or_more"> 3äººä»¥ä¸Š
                            </label>
                        </fieldset>
                    `;
                    crimeListElement.appendChild(itemDiv);
                });

            } catch (error) {
                console.error('ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                crimeListElement.innerHTML = `<span class="alert">ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</span>`;
            }
        }

        /**
         * è¨ˆç®—ã‚’å®Ÿè¡Œã™ã‚‹
         */
        document.getElementById('calculate-button').addEventListener('click', async () => {
            const checkedCrimes = document.querySelectorAll('input[name="crime"]:checked');
            const dataToSend = [];

            resultAmountSpan.textContent = 'è¨ˆç®—ä¸­...';
            resultAmountSpan.classList.remove('alert');

            if (checkedCrimes.length === 0) {
                resultAmountSpan.textContent = '0';
                alert('çŠ¯ç½ªåã‚’ä¸€ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // é¸æŠã•ã‚ŒãŸçŠ¯ç½ªåã¨ãã®ä»‹å…¥äººæ•°ã‚¿ã‚¤ãƒ—ã‚’åé›†
            checkedCrimes.forEach(checkbox => {
                const crimeName = checkbox.value;
                const index = checkbox.id.split('-')[1];
                
                // è©²å½“ã™ã‚‹ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰é¸æŠã•ã‚ŒãŸå€¤ã‚’å–å¾—
                const selectedTypeElement = document.querySelector(`input[name="intervention-${index}"]:checked`);
                const interventionType = selectedTypeElement ? selectedTypeElement.value : '2_or_less'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤

                dataToSend.push({
                    crime: crimeName,
                    type: interventionType
                });
            });

            try {
                // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: JSON.stringify({
                        selected_crimes: dataToSend
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP status ${response.status}`);
                }
                
                // GASã‹ã‚‰ã®JSONãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‘ãƒ¼ã‚¹
                const text = await response.text();
                const data = JSON.parse(text);

                if (data.error) {
                     throw new Error(`GAS Script Error: ${data.error}`);
                }

                // çµæœã‚’è¡¨ç¤º
                resultAmountSpan.textContent = data.total_amount.toLocaleString();

            } catch (error) {
                console.error('è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                resultAmountSpan.textContent = 'ã‚¨ãƒ©ãƒ¼';
                resultAmountSpan.classList.add('alert');
                alert('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨GASã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«çŠ¯ç½ªãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦UIã‚’æ§‹ç¯‰
        fetchCrimesAndBuildUI();
    </script>
</body>
</html>