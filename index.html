<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº çŠ¯ç½ªé›»å“</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        h1 { border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        .crime-item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .crime-item label { margin-right: 15px; }
        #crime-list { min-height: 50px; }
        .loading { color: gray; font-style: italic; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; margin-top: 10px; }
        #result-display { margin-top: 20px; padding: 15px; border: 2px solid #333; font-size: 24px; font-weight: bold; background-color: #f9f9f9; text-align: center; }
        .alert { color: red; }
    </style>
</head>
<body>
    <h1>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº çŠ¯ç½ªé›»å“</h1>

    <h2>çŠ¯ç½ªã”ã¨ã®ä»‹å…¥äººæ•°ã¨é‡‘é¡ã®é¸æŠ</h2>
    
    <div id="crime-list" class="loading">
        ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰çŠ¯ç½ªãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...
    </div>
    
    <button id="calculate-button">åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—</button>

    <div id="result-display">
        åˆè¨ˆé‡‘é¡: <span id="result-amount">0</span> å††
    </div>

    <script>
        // ğŸš¨ ã€æœ€é‡è¦ã€‘ã“ã“ã«æ–°ã—ã„GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ ğŸš¨
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyVnyOcLkPn22Jfhjk_u-dquA-nfLTgYxu9o9pmBikLEaW-GwAH7oWfFZBXW65LUfEl/exec';
        const crimeListElement = document.getElementById('crime-list');
        const resultAmountSpan = document.getElementById('result-amount');

        /**
         * GASã‹ã‚‰çŠ¯ç½ªåãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€UIã‚’å‹•çš„ã«æ§‹ç¯‰ã™ã‚‹
         */
        async function fetchCrimesAndBuildUI() {
            try {
                // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error(`HTTP status ${response.status}`);
                }
                
                const text = await response.text();
                const data = JSON.parse(text);
                
                if (data.error) {
                     // GASã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆï¼ˆä¾‹ï¼šã‚·ãƒ¼ãƒˆåé–“é•ã„ï¼‰
                     throw new Error(`GAS Script Error: ${data.error}`);
                }
                if (!data.crimeList) {
                     // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒä¸æ­£ãªå ´åˆ
                     throw new Error('GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒä¸æ­£ã§ã™ã€‚');
                }

                crimeListElement.classList.remove('loading');
                crimeListElement.innerHTML = '';
                
                data.crimeList.forEach((crimeName, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'crime-item';
                    itemDiv.innerHTML = `
                        <input type="checkbox" id="crime-${index}" name="crime" value="${crimeName}">
                        <label for="crime-${index}"><strong>${crimeName}</strong></label>
                        <br>
                        <fieldset style="display: inline-block; margin-top: 5px;">
                            <legend>ä»‹å…¥äººæ•°</legend>
                            <label>
                                <input type="radio" name="intervention-${index}" value="2_or_less" checked> 2äººä»¥ä¸‹
                            </label>
                            <label>
                                <input type="radio" name="intervention-${index}" value="3_or_more"> 3äººä»¥ä¸Š
                            </label>
                        </fieldset>
                    `;
                    crimeListElement.appendChild(itemDiv);
                });

            } catch (error) {
                console.error('ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                resultAmountSpan.textContent = 'ã‚¨ãƒ©ãƒ¼';
                crimeListElement.innerHTML = `<span class="alert">ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</span>`;
            }
        }

        /**
         * è¨ˆç®—ã‚’å®Ÿè¡Œã™ã‚‹
         */
        document.getElementById('calculate-button').addEventListener('click', async () => {
            const checkedCrimes = document.querySelectorAll('input[name="crime"]:checked');
            const dataToSend = [];

            resultAmountSpan.textContent = 'è¨ˆç®—ä¸­...';
            resultAmountSpan.classList.remove('alert');

            if (checkedCrimes.length === 0) {
                resultAmountSpan.textContent = '0';
                alert('çŠ¯ç½ªåã‚’ä¸€ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            checkedCrimes.forEach(checkbox => {
                const crimeName = checkbox.value;
                const index = checkbox.id.split('-')[1];
                
                const selectedTypeElement = document.querySelector(`input[name="intervention-${index}"]:checked`);
                const interventionType = selectedTypeElement ? selectedTypeElement.value : '2_or_less';

                dataToSend.push({
                    crime: crimeName,
                    type: interventionType
                });
            });

            try {
                // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: JSON.stringify({
                        selected_crimes: dataToSend
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP status ${response.status}`);
                }
                
                const text = await response.text();
                const data = JSON.parse(text);

                if (data.error) {
                     throw new Error(`GAS Script Error: ${data.error}`);
                }

                resultAmountSpan.textContent = data.total_amount.toLocaleString();

            } catch (error) {
                console.error('è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                resultAmountSpan.textContent = 'ã‚¨ãƒ©ãƒ¼';
                resultAmountSpan.classList.add('alert');
                alert('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨GASã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });

        fetchCrimesAndBuildUI();
    </script>
</body>
</html>